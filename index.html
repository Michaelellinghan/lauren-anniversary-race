<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Race Across London! 🚆</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&family=Lobster&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #74b9ff; /* Static background color */
            overflow-x: hidden;
        }

        .font-lobster {
            font-family: 'Lobster', cursive;
        }

        .page {
            display: none;
            animation: fadeIn 0.7s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .btn {
            @apply inline-block px-8 py-4 text-lg font-bold text-white rounded-full shadow-lg transition-transform duration-300 ease-in-out;
            background-color: #e73c7e;
            border: 2px solid white;
        }
        .btn-small {
            @apply px-4 py-2 text-sm;
        }

        .btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            @apply bg-gray-400 cursor-not-allowed;
            transform: scale(1);
        }

        .info-box {
            @apply bg-white/20 backdrop-blur-sm p-6 rounded-2xl shadow-lg mt-6;
        }

        /* Train Animation */
        #train-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
        }

        #train {
            position: absolute;
            left: -200px; /* Start off-screen */
            width: 150px;
            animation: move-train 1.2s ease-in-out forwards;
        }

        @keyframes move-train {
            0% { left: -200px; }
            100% { left: 100vw; } /* Move across the full screen width */
        }

        /* Emergency Stop Button & Modal */
        #emergency-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #c0392b;
            color: white;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            font-size: 14px;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 3px solid white;
            z-index: 90;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #emergency-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 110;
            display: none;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        /* Map Styling */
        .map-container {
            @apply bg-white/80 backdrop-blur-sm p-4 rounded-3xl shadow-2xl my-6 relative;
            transition: transform 0.5s ease-in-out;
        }
        .map-container.zoomed {
            transform: scale(1.03);
        }
        .map-path {
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: draw-line 2s ease-in-out forwards 0.5s;
        }
        
        @keyframes draw-line {
            to {
                stroke-dashoffset: 0;
            }
        }

        @keyframes pulse {
            0% { r: 3; opacity: 1; }
            50% { r: 5; opacity: 0.5; }
            100% { r: 3; opacity: 1; }
        }
        .pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }

        #confetti-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 99;
            pointer-events: none;
        }
        
        .fact-box {
            @apply bg-yellow-200/80 backdrop-blur-sm p-4 rounded-2xl text-gray-800 italic mt-4 text-sm flex items-center gap-4;
            opacity: 0;
            animation: slide-in-fade 0.6s forwards;
        }

        .fox-mascot {
            width: 50px;
            height: auto;
            flex-shrink: 0;
        }

        @keyframes slide-in-fade {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .souvenir-icon {
            width: 40px;
            height: 40px;
            display: inline-block;
            margin: 0 5px;
        }

    </style>
</head>
<body class="text-gray-800">

    <canvas id="confetti-canvas"></canvas>

    <!-- Fox Mascot SVG Definition -->
    <svg width="0" height="0" style="position:absolute">
      <defs>
        <!-- Base Fox -->
        <g id="felix-the-fox-base">
            <path d="M 50 95 C 20 95, 20 60, 50 60 C 80 60, 80 95, 50 95 Z" fill="#E67E22"/>
            <path d="M 50 10 C 20 10, 20 65, 50 65 C 80 65, 80 10, 50 10 Z" fill="#E67E22"/>
            <path d="M 25 20 L 15 5 L 35 15 Z" fill="#E67E22"/><path d="M 75 20 L 85 5 L 65 15 Z" fill="#E67E22"/>
            <path d="M 27 18 L 20 8 L 34 15 Z" fill="#2C3E50"/><path d="M 73 18 L 80 8 L 66 15 Z" fill="#2C3E50"/>
            <path d="M 50 45 C 40 55, 60 55, 50 45 L 35 60 Q 50 70 65 60 Z" fill="#ECF0F1"/>
            <circle cx="40" cy="40" r="3" fill="#2C3E50"/><circle cx="60" cy="40" r="3" fill="#2C3E50"/>
            <circle cx="50" cy="50" r="2" fill="#2C3E50"/>
        </g>
        <!-- Normal Felix -->
        <g id="felix-the-fox">
            <use href="#felix-the-fox-base"/>
            <path d="M 50 5 C 30 5, 30 20, 50 20 C 70 20, 70 5, 50 5 Z" fill="#2C3E50"/>
            <rect x="25" y="18" width="50" height="4" rx="2" fill="#2C3E50"/>
        </g>
        <!-- Felix with Sunglasses -->
        <g id="felix-sunny">
             <use href="#felix-the-fox-base"/>
             <path d="M 35 38 h 30 v 10 h -30 z" fill="#2C3E50" rx="3"/>
             <path d="M 48 38 v 5" stroke="white" stroke-width="1"/>
        </g>
        <!-- Felix with Umbrella -->
        <g id="felix-rainy">
            <use href="#felix-the-fox-base"/>
            <path d="M 0 20 Q 50 -20, 100 20" fill="#3498db"/>
            <path d="M 50 0 v 30" stroke="#2c3e50" stroke-width="3"/>
        </g>
        <!-- Felix Celebrating -->
        <g id="felix-celebrating">
            <use href="#felix-the-fox"/>
            <path d="M 20 75 C 10 65, 10 55, 20 55" stroke="#E67E22" stroke-width="8" fill="none" stroke-linecap="round"/>
            <path d="M 80 75 C 90 65, 90 55, 80 55" stroke="#E67E22" stroke-width="8" fill="none" stroke-linecap="round"/>
        </g>
        <!-- Felix Photobomb -->
        <g id="felix-photobomb" transform="rotate(15 50 50)">
            <use href="#felix-the-fox-base" />
            <path d="M 50 5 C 30 5, 30 20, 50 20 C 70 20, 70 5, 50 5 Z" fill="#2C3E50"/>
            <rect x="25" y="18" width="50" height="4" rx="2" fill="#2C3E50"/>
        </g>
        <!-- Souvenir Icons -->
        <g id="souvenir-phonebox" viewBox="0 0 24 24"><path fill="#d32f2f" d="M18,2H6C4.9,2,4,2.9,4,4v16c0,1.1,0.9,2,2,2h12c1.1,0,2-0.9,2-2V4C20,2.9,19.1,2,18,2z M17,18h-2v-2h2V18z M17,14h-2v-2h2V14z M17,10h-2V8h2V10z M13,18H7V6h6V18z"/></g>
        <g id="souvenir-masks" viewBox="0 0 24 24"><path fill="#fdd835" d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M9,16c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3S10.66,16,9,16z M15,16c-1.66,0-3-1.34-3-3s1.34-3,3-3s3,1.34,3,3S16.66,16,15,16z"/><path fill="#424242" d="M12,18c-2.48,0-4.65-1.28-6-3.25c0.04-3.97,4.01-6.2,6-6.2s5.96,2.23,6,6.2C16.65,16.72,14.48,18,12,18z"/></g>
        <g id="souvenir-crown" viewBox="0 0 24 24"><path fill="#ffc107" d="M5,16L3,5l5.5,5L12,4l3.5,6L21,5l-2,11H5z M19,18H5v2h14V18z"/></g>
        <g id="souvenir-beer" viewBox="0 0 24 24"><path fill="#ff9800" d="M20,8h-3V4h-2v4h-2V4h-2v4H6c-1.1,0-2,0.9-2,2v8c0,1.1,0.9,2,2,2h14c1.1,0,2-0.9,2-2v-8C22,8.9,21.1,8,20,8z"/></g>
      </defs>
    </svg>

    <!-- Train Transition Overlay -->
    <div id="train-transition">
        <p class="font-lobster text-white text-2xl mb-4">Minding the gap...</p>
        <svg id="train" viewBox="0 0 200 100" xmlns="http://www.w3.org/2000/svg">
            <use href="#train-body"/>
        </svg>
    </div>

    <!-- Emergency Stop Modal -->
    <div id="emergency-modal" onclick="hideEmergencyModal()">
        <div class="bg-white p-8 rounded-2xl text-center shadow-lg max-w-sm flex flex-col items-center">
             <svg class="fox-mascot" viewBox="0 0 100 100"><use href="#felix-the-fox"></use></svg>
            <h3 class="font-lobster text-3xl text-red-600 mb-4">Emergency Stop!</h3>
            <p id="emergency-message" class="text-lg text-gray-700"></p>
            <button onclick="hideEmergencyModal(event)" class="btn mt-6">Resume Race</button>
        </div>
    </div>

    <!-- Countdown Timer Header -->
    <header class="sticky top-0 left-0 right-0 bg-black/50 backdrop-blur-sm p-2 text-white text-center shadow-lg z-40">
        <div id="countdown" class="flex justify-center items-center space-x-2 md:space-x-4">
            <!-- Countdown will be injected here by JS -->
        </div>
    </header>

    <div class="container mx-auto p-4 md:p-8 max-w-2xl">

        <!-- Page 0: Opening -->
        <div id="page-0" class="page active text-center text-white">
            <h1 class="font-lobster text-5xl md:text-7xl mb-4">Race Across London! 🚆</h1>
            <h2 class="text-2xl md:text-3xl font-bold mb-8">A special 7th anniversary adventure!</h2>
            
            <div class="bg-white/80 backdrop-blur-sm p-8 rounded-3xl shadow-2xl text-gray-700 space-y-4 text-left">
                <p class="text-lg">Welcome to your Race Across London! (Legally different from Race Across the World 😉)</p>
                <p>Lauren, I hope you’re ready for a special anniversary adventure I have prepared for you!</p>
                <p>This is your very own 'Race Across London' – an exciting journey with various checkpoints and questions!</p>
                <p class="text-sm text-center italic text-red-500">P.S. You can press the red 'STOP' button at any time to pause the race timer!</p>
                <hr class="my-6 border-pink-300">
                <h3 class="font-bold text-xl text-pink-500">Pre-Race Challenge:</h3>
                <p>Your first mission is to prepare a suitcase for 4 days and head to 78 Tattershall drive!</p>
                <p>We’ll head to Hemel today, whenever my parents arrive and you are ready. We’ll be staying in London for one night tomorrow, and in Hemel until Sunday.</p>
                <hr class="my-6 border-pink-300">
                <p class="font-bold text-center">The main race starts on <span class="text-pink-500">26th July 2025</span>! Come back then to begin your grand journey!</p>
            </div>

            <button id="start-race-btn" onclick="navigateTo(1)" class="btn mt-8">Start Your London Race</button>
            <p id="start-race-message" class="mt-2 text-white/80"></p>
        </div>

        <!-- Page 1: Stanmore Start -->
        <div id="page-1" class="page text-center text-white">
            <h1 class="font-lobster text-4xl md:text-6xl mb-6">Your Grand Adventure Begins!</h1>
             <div class="map-container">
                <svg id="map-1" viewBox="0 0 100 100" class="w-full h-auto"></svg>
            </div>
            <div class="bg-white/80 backdrop-blur-sm p-8 rounded-3xl shadow-2xl text-gray-700 space-y-4 text-left">
                <h2 class="font-bold text-2xl text-center text-pink-500">Destination: Stanmore Station!</h2>
                <div class="fact-box">
                     <svg class="fox-mascot" viewBox="0 0 100 100" id="weather-fox-1"></svg>
                    <p><strong>Did you know?</strong> Stanmore was home to RAF Bentley Priory, the HQ of Fighter Command during the Battle of Britain.</p>
                </div>
                <p>Welcome to your very own Race Across London Lauren! Your first mission is to get from 78 Tattershall Drive, all the way to Stanmore Train Station in London. Here’s the catch though… No phones allowed, except to view this website! Michael will provide you with a map of London, but you must work out the rest yourself! I hope you remember the way 🤨</p>
                <hr class="my-6 border-pink-300">
                <p class="font-bold text-xl text-center">Your first mission: From 22 Kennedy Drive, NG9 8HT, travel to Stanmore Train Station, HA7 2DX. Travel however you like!</p>
            </div>
            <button onclick="navigateTo(2)" class="btn mt-8">Next Stage</button>
        </div>

        <!-- Page 2: Warwick Avenue Travel -->
        <div id="page-2" class="page text-center text-white">
            <h1 class="font-lobster text-4xl md:text-6xl mb-6">To 'Little Venice'</h1>
             <div class="map-container">
                <svg id="map-2" viewBox="0 0 100 100" class="w-full h-auto"></svg>
            </div>
             <div class="bg-white/80 backdrop-blur-sm p-8 rounded-3xl shadow-2xl text-gray-700 space-y-4 text-left">
                <p>Excellent! You've made it to Stanmore, the gateway to your London adventure. Our first destination takes you to the charming waterways of 'Little Venice'.</p>
                <div class="fact-box">
                    <svg class="fox-mascot" viewBox="0 0 100 100" id="weather-fox-2"></svg>
                    <p><strong>Did you know?</strong> The area is home to the Puppet Theatre Barge, a unique 55-seat floating puppet theatre.</p>
                </div>
                <hr class="my-6 border-pink-300">
                <p class="font-bold text-xl text-center">Your task: From Stanmore Station, travel to Warwick Avenue.</p>
            </div>
            <button onclick="navigateTo(3)" class="btn mt-8">I’ve Arrived</button>
        </div>

        <!-- Page 3: Checkpoint 1 -->
        <div id="page-3" class="page text-center text-white">
            <h1 class="font-lobster text-4xl md:text-6xl mb-6">Checkpoint 1</h1>
            <div class="bg-white/80 backdrop-blur-sm p-8 rounded-3xl shadow-2xl text-gray-700 space-y-4 text-left">
                <div class="flex items-center justify-center gap-4">
                    <svg class="fox-mascot" viewBox="0 0 100 100"><use href="#felix-the-fox"></use></svg>
                    <p>Find a garden-lined street with a name that links to a city in the South West of England. Head along this street until you reach a mini roundabout.</p>
                </div>
                <hr class="my-6 border-pink-300">
                <h3 class="font-bold text-xl text-center text-pink-500">Question:</h3>
                <p class="text-center">What is on the corner between Formosa Street and Bristol Gardens?</p>
                
                <div class="mt-4 text-center">
                    <input id="answer-1" type="text" class="w-full max-w-sm p-3 rounded-lg border-2 border-pink-300 focus:ring-pink-500 focus:border-pink-500 text-center" placeholder="Your answer here">
                    <p id="feedback-1" class="mt-2 h-6 font-bold"></p>
                    <div id="q1-buttons" class="mt-4 space-x-4 inline-flex">
                        <button onclick="checkAnswer(1)" class="btn">Submit</button>
                        <button onclick="giveUp(1)" class="btn bg-gray-500">Give Up 😔</button>
                    </div>
                    <div id="hint-container-1" class="mt-4">
                        <button onclick="showHint(1)" class="btn btn-small bg-blue-500">Need a hint?</button>
                        <p id="hint-1" class="mt-2 text-black italic" style="display: none;"></p>
                    </div>
                </div>
            </div>
            
            <div id="info-1" class="hidden mt-6 text-left text-white">
                 <div class="info-box">
                    <h3 class="font-bold text-2xl mb-4 text-center">Local Highlights</h3>
                    <h4 class="font-bold text-lg text-pink-100">Coffee & Lunch Stops:</h4>
                    <ul class="list-disc list-inside space-y-2 mt-2">
                        <li><b>Coffee Shop:</b> Cafe Laville is a unique café that sits directly over the canal, offering lovely views.</li>
                        <li><b>Lunch Restaurant:</b> The Waterway is a fantastic gastropub with a large terrace right on the canal.</li>
                    </ul>
                    <h4 class="font-bold text-lg mt-4 text-pink-100">Other Places to Check Out:</h4>
                    <ul class="list-disc list-inside space-y-2 mt-2">
                        <li><b>Rembrandt Gardens:</b> A beautiful and tranquil canalside garden, perfect for a brief, quiet moment.</li>
                        <li><b>Walk the Waterway:</b> How about a 5-10 minute stroll along the canal towpath towards Paddington?</li>
                    </ul>
                    <div id="selfie-prompt-1" class="mt-4 p-4 bg-pink-100 text-pink-800 rounded-lg text-center font-bold" style="display: none;"></div>
                </div>
                <div class="text-center">
                    <button onclick="navigateTo(4)" class="btn mt-8">Next Stage</button>
                </div>
            </div>
        </div>
        
        <!-- Page 4: Leicester Square Travel -->
        <div id="page-4" class="page text-center text-white">
            <h1 class="font-lobster text-4xl md:text-6xl mb-6">Heart of Theatreland</h1>
            <div class="map-container">
                <svg id="map-4" viewBox="0 0 100 100" class="w-full h-auto"></svg>
            </div>
             <div class="bg-white/80 backdrop-blur-sm p-8 rounded-3xl shadow-2xl text-gray-700 space-y-4 text-left">
                <p>Well done! Now, let's head to the heart of Theatreland.</p>
                 <div class="fact-box">
                    <svg class="fox-mascot" viewBox="0 0 100 100" id="weather-fox-4"></svg>
                    <p><strong>Did you know?</strong> The first ever public film screening in the UK took place at the Regent Street Polytechnic, just a short walk from Leicester Square, in 1896.</p>
                </div>
                <hr class="my-6 border-pink-300">
                <p class="font-bold text-xl text-center">Your task: Travel to Leicester Square.</p>
            </div>
            <button onclick="navigateTo(5)" class="btn mt-8">I’ve Arrived</button>
        </div>

        <!-- Page 5: Checkpoint 2 -->
        <div id="page-5" class="page text-center text-white">
            <h1 class="font-lobster text-4xl md:text-6xl mb-6">Checkpoint 2</h1>
            <div class="bg-white/80 backdrop-blur-sm p-8 rounded-3xl shadow-2xl text-gray-700 space-y-4 text-left">
                <div class="flex items-center justify-center gap-4">
                    <svg class="fox-mascot" viewBox="0 0 100 100"><use href="#felix-the-fox"></use></svg>
                    <p>Find a famous restaurant located on West Street with ties to one of our children.</p>
                </div>
                <hr class="my-6 border-pink-300">
                <h3 class="font-bold text-xl text-center text-pink-500">Question:</h3>
                <p class="text-center">What letter is repeated twice on the clock?</p>
                
                <div class="mt-4 text-center">
                    <input id="answer-2" type="text" class="w-full max-w-sm p-3 rounded-lg border-2 border-pink-300 focus:ring-pink-500 focus:border-pink-500 text-center" placeholder="Your answer here">
                    <p id="feedback-2" class="mt-2 h-6 font-bold"></p>
                    <div id="q2-buttons" class="mt-4 space-x-4 inline-flex">
                        <button onclick="checkAnswer(2)" class="btn">Submit</button>
                        <button onclick="giveUp(2)" class="btn bg-gray-500">Give Up 😔</button>
                    </div>
                    <div id="hint-container-2" class="mt-4">
                        <button onclick="showHint(2)" class="btn btn-small bg-blue-500">Need a hint?</button>
                        <p id="hint-2" class="mt-2 text-black italic" style="display: none;"></p>
                    </div>
                </div>
            </div>
            
            <div id="info-2" class="hidden mt-6 text-left text-white">
                 <div class="info-box">
                    <h3 class="font-bold text-2xl mb-4 text-center">Local Highlights</h3>
                    <h4 class="font-bold text-lg text-pink-100">Coffee & Lunch Stops (sorry, we’re not eating here):</h4>
                    <ul class="list-disc list-inside space-y-2 mt-2">
                        <li><b>Coffee Shop:</b> Abuelo is a lovely, relaxed Australian-meets-South American café just around the corner.</li>
                        <li><b>Lunch Restaurant:</b> Dishoom Covent Garden is an incredibly popular spot for delicious Bombay-inspired food.</li>
                    </ul>
                    <h4 class="font-bold text-lg mt-4 text-pink-100">Other Places to Check Out:</h4>
                    <ul class="list-disc list-inside space-y-2 mt-2">
                        <li><b>Neal's Yard:</b> A must-see hidden gem, exploding with colour.</li>
                        <li><b>The London Transport Museum:</b> Given the theme of the race, this is very fitting!</li>
                        <li><b>Covent Garden's Street Performers:</b> Soak up the lively atmosphere.</li>
                        <li><b>Evening Plans:</b> We could come back for 9:05 to see Rachel Zegler on the balcony of the London Palladium!</li>
                    </ul>
                    <div id="selfie-prompt-2" class="mt-4 p-4 bg-pink-100 text-pink-800 rounded-lg text-center font-bold" style="display: none;"></div>
                </div>
                <div class="text-center">
                    <button onclick="navigateTo(6)" class="btn mt-8">Next Stage</button>
                </div>
            </div>
        </div>

        <!-- Page 6: Green Park Travel -->
        <div id="page-6" class="page text-center text-white">
            <h1 class="font-lobster text-4xl md:text-6xl mb-6">A Touch of Grandeur</h1>
            <div class="map-container">
                <svg id="map-6" viewBox="0 0 100 100" class="w-full h-auto"></svg>
            </div>
             <div class="bg-white/80 backdrop-blur-sm p-8 rounded-3xl shadow-2xl text-gray-700 space-y-4 text-left">
                <p>Great job! Now it’s time for a touch of grandeur.</p>
                <div class="fact-box">
                    <svg class="fox-mascot" viewBox="0 0 100 100" id="weather-fox-6"></svg>
                    <p><strong>Did you know?</strong> It's said no flowers grow in Green Park because Queen Catherine ordered them removed after catching King Charles II picking them there for another woman!</p>
                </div>
                <hr class="my-6 border-pink-300">
                <p class="font-bold text-xl text-center">Your task: Travel to Green Park.</p>
            </div>
            <button onclick="navigateTo(7)" class="btn mt-8">I’ve Arrived</button>
        </div>

        <!-- Page 7: Checkpoint 3 -->
        <div id="page-7" class="page text-center text-white">
            <h1 class="font-lobster text-4xl md:text-6xl mb-6">Checkpoint 3</h1>
            <div class="bg-white/80 backdrop-blur-sm p-8 rounded-3xl shadow-2xl text-gray-700 space-y-4 text-left">
                <div class="flex items-center justify-center gap-4">
                    <svg class="fox-mascot" viewBox="0 0 100 100"><use href="#felix-the-fox"></use></svg>
                    <p>Find the magnificent private mansion that has been used as a filming location for The Crawley’s London home in Downton Abbey located at 14 Cleveland Road. It overlooks Green Park and is a short walk from here.</p>
                </div>
                <hr class="my-6 border-pink-300">
                <h3 class="font-bold text-xl text-center text-pink-500">Question:</h3>
                <p class="text-center">What animal is seen above the arch in the doorway?</p>
                
                <div class="mt-4 text-center">
                    <input id="answer-3" type="text" class="w-full max-w-sm p-3 rounded-lg border-2 border-pink-300 focus:ring-pink-500 focus:border-pink-500 text-center" placeholder="Your answer here">
                    <p id="feedback-3" class="mt-2 h-6 font-bold"></p>
                    <div id="q3-buttons" class="mt-4 space-x-4 inline-flex">
                        <button onclick="checkAnswer(3)" class="btn">Submit</button>
                        <button onclick="giveUp(3)" class="btn bg-gray-500">Give Up 😔</button>
                    </div>
                    <div id="hint-container-3" class="mt-4">
                        <button onclick="showHint(3)" class="btn btn-small bg-blue-500">Need a hint?</button>
                        <p id="hint-3" class="mt-2 text-black italic" style="display: none;"></p>
                    </div>
                </div>
            </div>
            
            <div id="info-3" class="hidden mt-6 text-left text-white">
                 <div class="info-box">
                    <h3 class="font-bold text-2xl mb-4 text-center">Local Highlights</h3>
                    <h4 class="font-bold text-lg text-pink-100">Coffee & Lunch Stops:</h4>
                    <ul class="list-disc list-inside space-y-2 mt-2">
                        <li><b>Coffee Shop:</b> Colicci at the entrance to Green Park offers coffee and snacks with a view.</li>
                        <li><b>Lunch Restaurant:</b> The Wolseley on Piccadilly is an elegant European grand café.</li>
                    </ul>
                    <h4 class="font-bold text-lg mt-4 text-pink-100">Other Places to Check Out:</h4>
                    <ul class="list-disc list-inside space-y-2 mt-2">
                        <li><b>A "Fly-by" of Buckingham Palace:</b> We're right on the doorstep!</li>
                        <li><b>Spencer House:</b> Another magnificent aristocratic town house, Princess Diana's ancestral home.</li>
                        <li><b>Fortnum & Mason:</b> A quick walk through this famous luxury department store is an experience in itself.</li>
                    </ul>
                    <div id="selfie-prompt-3" class="mt-4 p-4 bg-pink-100 text-pink-800 rounded-lg text-center font-bold" style="display: none;"></div>
                </div>
                <div class="text-center">
                    <button onclick="navigateTo(8)" class="btn mt-8">Next Stage</button>
                </div>
            </div>
        </div>

        <!-- Page 8: London Bridge Travel -->
        <div id="page-8" class="page text-center text-white">
            <h1 class="font-lobster text-4xl md:text-6xl mb-6">Cross the River</h1>
            <div class="map-container">
                <svg id="map-8" viewBox="0 0 100 100" class="w-full h-auto"></svg>
            </div>
             <div class="bg-white/80 backdrop-blur-sm p-8 rounded-3xl shadow-2xl text-gray-700 space-y-4 text-left">
                <p>Great job! Now it’s time to cross the river.</p>
                 <div class="fact-box">
                    <svg class="fox-mascot" viewBox="0 0 100 100" id="weather-fox-8"></svg>
                    <p><strong>Did you know?</strong> The nursery rhyme "London Bridge Is Falling Down" may refer to one of the many earlier versions of the bridge that have stood here since Roman times.</p>
                </div>
                <hr class="my-6 border-pink-300">
                <p class="font-bold text-xl text-center">Your task: Travel to London Bridge.</p>
            </div>
            <button onclick="navigateTo(9)" class="btn mt-8">I’ve Arrived</button>
        </div>

        <!-- Page 9: Checkpoint 4 -->
        <div id="page-9" class="page text-center text-white">
            <h1 class="font-lobster text-4xl md:text-6xl mb-6">Checkpoint 4</h1>
            <div class="bg-white/80 backdrop-blur-sm p-8 rounded-3xl shadow-2xl text-gray-700 space-y-4 text-left">
                <div class="flex items-center justify-center gap-4">
                    <svg class="fox-mascot" viewBox="0 0 100 100"><use href="#felix-the-fox"></use></svg>
                    <p>Find London's last remaining galleried coaching inn. This historic pub is tucked away on Borough High St near London's most famous food market.</p>
                </div>
                <hr class="my-6 border-pink-300">
                <h3 class="font-bold text-xl text-center text-pink-500">Question:</h3>
                <p class="text-center">When was this inn established?</p>
                
                <div class="mt-4 text-center">
                    <input id="answer-4" type="text" class="w-full max-w-sm p-3 rounded-lg border-2 border-pink-300 focus:ring-pink-500 focus:border-pink-500 text-center" placeholder="Your answer here">
                    <p id="feedback-4" class="mt-2 h-6 font-bold"></p>
                    <div id="q4-buttons" class="mt-4 space-x-4 inline-flex">
                        <button onclick="checkAnswer(4)" class="btn">Submit</button>
                        <button onclick="giveUp(4)" class="btn bg-gray-500">Give Up 😔</button>
                    </div>
                    <div id="hint-container-4" class="mt-4">
                        <button onclick="showHint(4)" class="btn btn-small bg-blue-500">Need a hint?</button>
                        <p id="hint-4" class="mt-2 text-black italic" style="display: none;"></p>
                    </div>
                </div>
            </div>
            
            <div id="info-4" class="hidden mt-6 text-left text-white">
                 <div class="info-box">
                    <h3 class="font-bold text-2xl mb-4 text-center">Local Highlights</h3>
                    <h4 class="font-bold text-lg text-pink-100">Coffee & Lunch Stops:</h4>
                    <ul class="list-disc list-inside space-y-2 mt-2">
                        <li><b>Coffee Shop:</b> Monmouth Coffee Company in Borough Market is famous for its exceptional coffee.</li>
                        <li><b>Lunch Restaurant:</b> You are spoilt for choice at Borough Market! Or pop in the George Inn!</li>
                    </ul>
                    <h4 class="font-bold text-lg mt-4 text-pink-100">Other Places to Check Out:</h4>
                    <ul class="list-disc list-inside space-y-2 mt-2">
                        <li><b>Southwark Cathedral:</b> This stunning Gothic cathedral is literally next door to Borough Market.</li>
                        <li><b>The Golden Hinde:</b> A beautiful full-size reconstruction of Sir Francis Drake's 16th-century galleon.</li>
                        <li><b>Shakespeare's Globe:</b> A little further along the river bank is the famous Globe theatre.</li>
                    </ul>
                    <div id="selfie-prompt-4" class="mt-4 p-4 bg-pink-100 text-pink-800 rounded-lg text-center font-bold" style="display: none;"></div>
                </div>
                <div class="text-center">
                    <button onclick="navigateTo(10)" class="btn mt-8">Next Stage</button>
                </div>
            </div>
        </div>
        
        <!-- Page 10: Islington Travel -->
        <div id="page-10" class="page text-center text-white">
            <h1 class="font-lobster text-4xl md:text-6xl mb-6">The Final Leg!</h1>
            <div class="map-container">
                <svg id="map-10" viewBox="0 0 100 100" class="w-full h-auto"></svg>
            </div>
             <div class="bg-white/80 backdrop-blur-sm p-8 rounded-3xl shadow-2xl text-gray-700 space-y-4 text-left">
                <p>Perfect. One more destination before we go find our hotel at 72 Prebend Street.</p>
                 <div class="fact-box">
                    <svg class="fox-mascot" viewBox="0 0 100 100" id="weather-fox-10"></svg>
                    <p><strong>Did you know?</strong> George Orwell lived in Islington while writing parts of *Nineteen Eighty-Four*.</p>
                </div>
                <hr class="my-6 border-pink-300">
                <p class="font-bold text-xl text-center">Your task: Travel to Islington.</p>
            </div>
            <button onclick="navigateTo(11)" class="btn mt-8">I’ve Arrived at the Hotel!</button>
        </div>

        <!-- Page 11: Finish Line -->
        <div id="page-11" class="page text-center text-white">
            <h1 class="font-lobster text-4xl md:text-6xl mb-6">You've Reached the Finish Line!</h1>
            <div class="bg-white/80 backdrop-blur-sm p-8 rounded-3xl shadow-2xl text-gray-700 space-y-4 text-center">
                <p class="text-xl">Congratulations on completing all the checkpoints!</p>
                <p>You're at the final destination for today's race.</p>
                <p class="font-bold mt-4">Ready to stop the clock and see your results?</p>
            </div>
            <button onclick="navigateTo(12)" class="btn mt-8">Finish Today's Race!</button>
        </div>
        
        <!-- Page 12: Race Log -->
        <div id="page-12" class="page text-center text-white">
            <h1 class="font-lobster text-5xl md:text-7xl mb-4">Race Complete!</h1>
            <div class="bg-white/80 backdrop-blur-sm p-8 rounded-3xl shadow-2xl text-gray-700 space-y-6">
                <h2 class="font-bold text-2xl text-center text-pink-500">Your Race Log</h2>
                <div class="flex justify-center my-4">
                    <svg class="w-24 h-24" viewBox="0 0 100 100"><use href="#felix-celebrating"></use></svg>
                </div>
                <div class="text-xl">
                    <p><strong>Checkpoints Completed:</strong> <span id="log-checkpoints"></span>/4</p>
                </div>
                <div class="text-xl">
                    <p><strong>Selfies Taken:</strong> <span id="log-selfies"></span></p>
                </div>
                <div class="text-xl">
                    <p><strong>Souvenirs Collected:</strong> <span id="log-souvenirs" class="text-2xl"></span></p>
                </div>
                <div class="text-xl">
                    <p><strong>Total Race Time:</strong> <span id="log-time"></span></p>
                </div>
                 <div class="text-xl font-bold text-yellow-500">
                    <p>🏆 <strong>Fastest Checkpoint:</strong> <span id="log-fastest"></span></p>
                </div>
                <hr class="my-4 border-pink-300">
                <div class="mt-4 text-center">
                    <h3 class="font-bold text-xl text-pink-500">Photo Finish!</h3>
                    <p class="mb-4">Upload a victory selfie to remember this moment!</p>
                    <label for="photo-upload" class="btn cursor-pointer">Upload Photo 📸</label>
                    <input type="file" id="photo-upload" accept="image/*" class="hidden" onchange="handlePhotoUpload(event)">
                    <div id="photo-finish-container" class="relative w-full max-w-md mx-auto mt-4" style="display: none;">
                        <img id="photo-finish-img" class="rounded-lg shadow-lg w-full h-auto">
                        <canvas id="photobomb-canvas" class="absolute top-0 left-0 w-full h-full"></canvas>
                    </div>
                </div>
                <hr class="my-4 border-pink-300">
                <p class="text-lg">Well done, Lauren! You've successfully completed your anniversary adventure across London. Time to relax!</p>
                <button onclick="navigateTo(13)" class="btn mt-8">What Now?</button>
            </div>
        </div>
        
        <!-- Page 13: Final Suggestions -->
        <div id="page-13" class="page text-white">
            <h1 class="font-lobster text-4xl md:text-6xl mb-6 text-center">The Adventure Continues...</h1>
            <div class="bg-white/80 backdrop-blur-sm p-8 rounded-3xl shadow-2xl text-gray-700 space-y-4 text-left">
                <p class="text-xl text-center">...tomorrow! But for now, what would you like to do?</p>
                 <div class="info-box text-gray-800">
                    <h3 class="font-bold text-2xl mb-4 text-center text-pink-500">For Coffee (Hyper-Local Gems)</h3>
                    <ul class="list-disc list-inside space-y-2 mt-2">
                        <li><b>Canal No.5:</b> A charming, independent café located directly on the Regent's Canal towpath.</li>
                        <li><b>The Common:</b> A top-quality, minimalist coffee shop focused on expertly made coffee.</li>
                        <li><b>The CoffeeWorks Project:</b> One of the best speciality coffee shops in the area on Camden Passage.</li>
                        <li><b>Kobo Cafe:</b> A lovely, relaxed local favourite on Upper Street.</li>
                    </ul>
                </div>
                 <div class="info-box text-gray-800">
                    <h3 class="font-bold text-2xl mb-4 text-center text-pink-500">For a Celebratory Lunch or Dinner</h3>
                    <ul class="list-disc list-inside space-y-2 mt-2">
                        <li><b>The Duke of Cambridge:</b> Britain's first certified organic pub, practically next door.</li>
                        <li><b>Frederick's:</b> Known for its beautiful conservatory dining room and modern European food.</li>
                        <li><b>The Plaquemine Lock:</b> Serves authentic Louisiana Cajun and Creole food with a brilliant, buzzy atmosphere.</li>
                        <li><b>Trullo:</b> A superb and highly-acclaimed Italian restaurant famous for its hand-made pasta.</li>
                    </ul>
                </div>
                 <div class="info-box text-gray-800">
                    <h3 class="font-bold text-2xl mb-4 text-center text-pink-500">Closer, More Immediate Things To Do</h3>
                    <ul class="list-disc list-inside space-y-2 mt-2">
                        <li><b>Explore Camden Passage:</b> Famous for its antique shops, quirky boutiques, and market stalls.</li>
                        <li><b>A Walk Along the Regent's Canal:</b> We can be on the towpath in under a minute!</li>
                        <li><b>Explore St Peter's Street:</b> Has a wonderful, quiet "village" feel with its Georgian houses.</li>
                        <li><b>Have a Drink at a True Local's Pub:</b> The Wenlock Arms is a famous, award-winning "proper" pub.</li>
                    </ul>
                </div>
                <p class="font-bold text-xl text-center mt-8">Ready for tomorrow? Michael will reveal the plans then.</p>
            </div>
        </div>

    </div>

    <button id="emergency-btn" onclick="showEmergencyModal()">STOP</button>

    <script>
        // --- State Management ---
        let currentPage = 0;
        const pages = document.querySelectorAll('.page');
        const wrongAttempts = { 1: 0, 2: 0, 3: 0, 4: 0 };
        let raceStartTime;
        let checkpointsCompleted = 0;
        let selfiesTaken = 0;
        let raceTimerInterval;
        let isPaused = false;
        let pauseStartTime;
        let questionStartTime;
        const checkpointTimes = {};
        let collectedSouvenirs = [];
        let completedPaths = [];

        // --- Countdown Timer ---
        const countdownDate = new Date("2025-07-26T14:30:00").getTime();

        const countdownFunction = setInterval(() => {
            const now = new Date().getTime();
            const distance = countdownDate - now;

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            const countdownElement = document.getElementById("countdown");
            if (distance < 0) {
                clearInterval(countdownFunction);
                countdownElement.innerHTML = "<div class='font-bold text-lg'>The Race is ON!</div>";
            } else {
                 countdownElement.innerHTML = `
                    <div class='text-center'><div class='text-2xl font-bold'>${days}</div><div class='text-xs'>Days</div></div>
                    <div class='text-2xl font-bold'>:</div>
                    <div class='text-center'><div class='text-2xl font-bold'>${hours}</div><div class='text-xs'>Hours</div></div>
                    <div class='text-2xl font-bold'>:</div>
                    <div class='text-center'><div class='text-2xl font-bold'>${minutes}</div><div class='text-xs'>Mins</div></div>
                    <div class='text-2xl font-bold'>:</div>
                    <div class='text-center'><div class='text-2xl font-bold'>${seconds}</div><div class='text-xs'>Secs</div></div>
                 `;
            }
            
            const startButton = document.getElementById('start-race-btn');
            const startMessage = document.getElementById('start-race-message');
            startButton.disabled = false;
            startMessage.textContent = "Click to preview the race!";

        }, 1000);

        // --- Map Data & Functions ---
        const tubeMapData = {
            stations: {
                hemel: { x: 5, y: 5, name: "Hemel" },
                stanmore: { x: 20, y: 20, name: "Stanmore" },
                warwick: { x: 45, y: 45, name: "Warwick Ave" },
                leicester: { x: 65, y: 45, name: "Leic. Sq." },
                greenpark: { x: 55, y: 65, name: "Green Park" },
                londonbridge: { x: 80, y: 65, name: "Lon. Bridge" },
                islington: { x: 80, y: 35, name: "Islington" }
            },
            lines: [
                { from: 'hemel', to: 'stanmore' },
                { from: 'stanmore', to: 'warwick' },
                { from: 'warwick', to: 'leicester' },
                { from: 'leicester', to: 'greenpark' },
                { from: 'greenpark', to: 'londonbridge' },
                { from: 'londonbridge', to: 'islington' },
            ]
        };

        const riverThamesPath = `
            <path d="M 10 75 Q 50 85, 90 55" stroke="#a2d5f2" stroke-width="6" fill="none" opacity="0.5" />
        `;

        function drawTubeMap(svgId, currentStationKey) {
            const svg = document.getElementById(svgId);
            svg.innerHTML = riverThamesPath; 
            
            // Draw all lines
            tubeMapData.lines.forEach((line, index) => {
                const from = tubeMapData.stations[line.from];
                const to = tubeMapData.stations[line.to];
                const p = document.createElementNS("http://www.w3.org/2000/svg", "path");
                p.setAttribute("d", `M ${from.x} ${from.y} L ${to.x} ${to.y}`);
                p.setAttribute("stroke-width", "1.5");
                p.setAttribute("fill", "none");
                
                if (completedPaths.includes(index)) {
                     p.setAttribute("stroke", "#27ae60");
                } else {
                     p.setAttribute("stroke", "#bdc3c7");
                }
                svg.appendChild(p);
            });

            // Draw all stations
            for (const key in tubeMapData.stations) {
                const loc = tubeMapData.stations[key];
                const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                circle.setAttribute("id", `loc-${key}-${svgId}`);
                circle.setAttribute("cx", loc.x);
                circle.setAttribute("cy", loc.y);
                circle.setAttribute("r", "2");
                circle.setAttribute("fill", "white");
                circle.setAttribute("stroke", "#34495e");
                circle.setAttribute("stroke-width", "0.5");

                if (key === currentStationKey) {
                    circle.classList.add('pulse');
                    circle.setAttribute("fill", "#e73c7e");
                }
                svg.appendChild(circle);

                const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                text.setAttribute("x", loc.x + 3);
                text.setAttribute("y", loc.y + 1);
                text.setAttribute("font-size", "4");
                text.setAttribute("font-family", "Poppins");
                text.textContent = loc.name;
                svg.appendChild(text);
            }
        }

        // --- Navigation ---
        function navigateTo(pageIndex) {
            if (pageIndex === 1 && !raceStartTime) {
                raceStartTime = new Date();
                startRaceTimer();
            }

            const trainTransition = document.getElementById('train-transition');
            trainTransition.style.display = 'flex';
            
            setTimeout(() => {
                pages[currentPage].classList.remove('active');
                currentPage = pageIndex;
                pages[currentPage].classList.add('active');
                window.scrollTo(0, 0);
                trainTransition.style.display = 'none';
                
                const mapContainer = pages[currentPage].querySelector('.map-container');
                if(mapContainer) {
                    mapContainer.classList.add('zoomed');
                    setTimeout(() => mapContainer.classList.remove('zoomed'), 500);
                }

                if (pageIndex === 1) drawTubeMap('map-1', 'hemel');
                if (pageIndex === 2) { completedPaths.push(0); drawTubeMap('map-2', 'stanmore'); }
                if (pageIndex === 4) { completedPaths.push(1); drawTubeMap('map-4', 'warwick'); }
                if (pageIndex === 6) { completedPaths.push(2); drawTubeMap('map-6', 'leicester'); }
                if (pageIndex === 8) { completedPaths.push(3); drawTubeMap('map-8', 'greenpark'); }
                if (pageIndex === 10) { completedPaths.push(4); drawTubeMap('map-10', 'londonbridge'); }
                
                if ([3, 5, 7, 9].includes(pageIndex)) {
                    questionStartTime = new Date();
                }
                
                if (pageIndex === 12) {
                    clearInterval(raceTimerInterval);
                    document.getElementById('log-checkpoints').textContent = checkpointsCompleted;
                    document.getElementById('log-selfies').textContent = selfiesTaken;
                    document.getElementById('log-souvenirs').innerHTML = collectedSouvenirs.map(s => `<svg class="souvenir-icon" viewBox="0 0 24 24"><use href="#${s}"></use></svg>`).join('');
                    
                    let fastestTime = Infinity;
                    let fastestCp = null;
                    for (const cp in checkpointTimes) {
                        if (checkpointTimes[cp] < fastestTime) {
                            fastestTime = checkpointTimes[cp];
                            fastestCp = cp;
                        }
                    }
                    const fastestLogEl = document.getElementById('log-fastest');
                    if (fastestCp) {
                        fastestLogEl.textContent = `Checkpoint ${fastestCp} (${(fastestTime / 1000).toFixed(1)}s)`;
                    } else {
                        fastestLogEl.textContent = 'N/A';
                    }

                    launchConfetti();
                }

            }, 1200);
        }

        // --- Quiz Logic ---
        const souvenirs = {
            1: 'souvenir-phonebox', 2: 'souvenir-masks', 3: 'souvenir-crown', 4: 'souvenir-beer'
        };

        const answers = {
            1: { accepted: ['a phone box', 'phone box', 'a telephone box', 'telephone box', 'red phone box', 'red telephone box'], reveal: 'A phone box' },
            2: { accepted: ['v'], reveal: 'V' },
            3: { accepted: ['a lion', 'lion'], reveal: 'A Lion' },
            4: { accepted: ['1542'], reveal: '1542' }
        };

        const hints = {
            1: "Think of a classic red box, used for making calls before mobiles existed.",
            2: "This letter is also a Roman numeral.",
            3: "It's known as the 'king of the jungle'.",
            4: "It was established during the reign of King Henry VIII."
        };

        const selfiePrompts = {
            1: "Time for a victory selfie! Pose like you're making a top-secret call in your new-found phone box!",
            2: "Selfie time! Point dramatically at the clock like you've just solved a great mystery.",
            3: "You found it! Quick, a selfie! Look regal and pretend you own the place. Give us your best royal wave!",
            4: "Success! Time for a historical selfie. Pose with your best 'cheers' as if you're a 16th-century traveller enjoying a pint!"
        };

        function checkAnswer(checkpoint) {
            const feedbackEl = document.getElementById(`feedback-${checkpoint}`);
            const inputEl = document.getElementById(`answer-${checkpoint}`);
            const providedAnswer = inputEl.value.trim().toLowerCase();
            
            if (answers[checkpoint].accepted.includes(providedAnswer)) {
                const timeTaken = new Date() - questionStartTime;
                checkpointTimes[checkpoint] = timeTaken;
                feedbackEl.textContent = 'Well done! That\'s correct!';
                feedbackEl.classList.remove('text-red-500');
                feedbackEl.classList.add('text-green-500');
                revealInfo(checkpoint, true);
            } else {
                wrongAttempts[checkpoint]++;
                feedbackEl.classList.add('text-red-500');
                feedbackEl.classList.remove('text-green-500');
                if (wrongAttempts[checkpoint] >= 3) {
                    feedbackEl.textContent = `Sorry, that's not quite right. The correct answer is: ${answers[checkpoint].reveal}`;
                    revealInfo(checkpoint, false);
                } else {
                    feedbackEl.textContent = 'Not quite, try again!';
                    inputEl.value = '';
                }
            }
        }

        function giveUp(checkpoint) {
            const feedbackEl = document.getElementById(`feedback-${checkpoint}`);
            feedbackEl.textContent = `The correct answer is: ${answers[checkpoint].reveal}`;
            feedbackEl.classList.remove('text-red-500');
            feedbackEl.classList.add('text-blue-500');
            revealInfo(checkpoint, false);
        }

        function revealInfo(checkpoint, isCorrect) {
            document.getElementById(`info-${checkpoint}`).classList.remove('hidden');
            if (isCorrect) {
                checkpointsCompleted++;
                selfiesTaken++;
                collectedSouvenirs.push(souvenirs[checkpoint]);
                const selfieEl = document.getElementById(`selfie-prompt-${checkpoint}`);
                selfieEl.innerHTML = `📸 ${selfiePrompts[checkpoint]}`;
                selfieEl.style.display = 'block';
            }
            
            document.getElementById(`answer-${checkpoint}`).disabled = true;
            document.getElementById(`q${checkpoint}-buttons`).style.display = 'none';
            document.getElementById(`hint-container-${checkpoint}`).style.display = 'none';
        }

        function showHint(checkpoint) {
            const hintEl = document.getElementById(`hint-${checkpoint}`);
            hintEl.textContent = hints[checkpoint];
            hintEl.style.display = 'block';
        }

        // --- Emergency Stop ---
        const emergencyMessages = [
            "Time for an emergency cup of tea and a biscuit!",
            "Detour to the nearest cake shop! Race is paused.",
            "Mandatory 5-minute sightseeing break has been activated!",
            "Quick, hide! A ticket inspector is coming! (Just kidding, timer paused.)"
        ];

        function showEmergencyModal() {
            if (raceTimerInterval) {
                isPaused = true;
                pauseStartTime = new Date();
                clearInterval(raceTimerInterval);
            }
            const messageEl = document.getElementById('emergency-message');
            messageEl.textContent = emergencyMessages[Math.floor(Math.random() * emergencyMessages.length)];
            document.getElementById('emergency-modal').style.display = 'flex';
        }
        function hideEmergencyModal(event) {
            event.stopPropagation();
            if (raceStartTime && isPaused) {
                const pausedDuration = new Date() - pauseStartTime;
                raceStartTime = new Date(raceStartTime.getTime() + pausedDuration);
                startRaceTimer();
                isPaused = false;
            }
            document.getElementById('emergency-modal').style.display = 'none';
        }


        // --- Race Timer ---
        function startRaceTimer() {
            const timeLogEl = document.getElementById('log-time');
            raceTimerInterval = setInterval(() => {
                if (!isPaused) {
                    const now = new Date();
                    const diff = now - raceStartTime;
                    const hours = Math.floor(diff / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    timeLogEl.textContent = `${hours}h ${minutes}m ${seconds}s`;
                }
            }, 1000);
        }
        
        // --- Photo Finish ---
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const container = document.getElementById('photo-finish-container');
                    const imgEl = document.getElementById('photo-finish-img');
                    const canvas = document.getElementById('photobomb-canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const userImage = new Image();
                    userImage.onload = function() {
                        // Match canvas to image dimensions
                        canvas.width = userImage.width;
                        canvas.height = userImage.height;
                        
                        // Draw user image to hidden img tag to get it on the page
                        imgEl.src = e.target.result;
                        container.style.display = 'block';

                        // Draw photobomb fox
                        const foxSVG = document.getElementById('felix-photobomb');
                        const foxXML = new XMLSerializer().serializeToString(foxSVG);
                        const foxDataURL = 'data:image/svg+xml;base64,' + btoa(foxXML);
                        
                        const foxImage = new Image();
                        foxImage.onload = function() {
                            const foxSize = canvas.width * 0.25; // Fox is 25% of image width
                            const margin = canvas.width * 0.05;
                            ctx.drawImage(foxImage, canvas.width - foxSize - margin, canvas.height - foxSize - margin, foxSize, foxSize);
                        };
                        foxImage.src = foxDataURL;
                    };
                    userImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // --- Confetti ---
        const confettiCanvas = document.getElementById('confetti-canvas');
        const confettiCtx = confettiCanvas.getContext('2d');
        let confettiParticles = [];
        const confettiCount = 200;
        const colors = ['#e73c7e', '#23a6d5', '#23d5ab', '#ee7752', '#feca57'];

        function launchConfetti() {
            confettiCanvas.width = window.innerWidth;
            confettiCanvas.height = window.innerHeight;
            confettiParticles = [];
            for (let i = 0; i < confettiCount; i++) {
                confettiParticles.push({
                    x: Math.random() * confettiCanvas.width,
                    y: -20,
                    w: Math.random() * 10 + 5,
                    h: Math.random() * 10 + 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    speed: Math.random() * 3 + 2,
                    tilt: Math.random() * 10 - 5,
                    tiltAngle: 0
                });
            }
            animateConfetti();
        }

        function animateConfetti() {
            confettiCtx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
            confettiParticles.forEach((p, i) => {
                p.y += p.speed;
                p.tiltAngle += 0.1;
                p.x += Math.sin(p.tiltAngle) * 2;
                confettiCtx.fillStyle = p.color;
                confettiCtx.save();
                confettiCtx.translate(p.x + p.w / 2, p.y + p.h / 2);
                confettiCtx.rotate(p.tiltAngle);
                confettiCtx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
                confettiCtx.restore();

                if (p.y > confettiCanvas.height) {
                    confettiParticles.splice(i, 1);
                }
            });
            if (confettiParticles.length > 0) {
                requestAnimationFrame(animateConfetti);
            }
        }

        // --- Weather ---
        async function getLondonWeather() {
            try {
                const response = await fetch('https://wttr.in/London?format=j1');
                const data = await response.json();
                const weatherDesc = data.current_condition[0].weatherDesc[0].value.toLowerCase();
                
                let weatherFoxId = 'felix-the-fox';
                if (weatherDesc.includes('rain') || weatherDesc.includes('shower') || weatherDesc.includes('drizzle')) {
                    weatherFoxId = 'felix-rainy';
                } else if (weatherDesc.includes('sunny') || weatherDesc.includes('clear')) {
                    weatherFoxId = 'felix-sunny';
                }
                
                document.querySelectorAll('[id^="weather-fox-"]').forEach(el => {
                    el.innerHTML = `<use href="#${weatherFoxId}"></use>`;
                });

            } catch (error) {
                console.error("Couldn't fetch weather data.", error);
                 document.querySelectorAll('[id^="weather-fox-"]').forEach(el => {
                    el.innerHTML = `<use href="#felix-the-fox"></use>`;
                });
            }
        }

        // Initialize first page
        document.addEventListener('DOMContentLoaded', () => {
             pages[0].classList.add('active');
             getLondonWeather();
        });
    </script>

</body>
</html>
